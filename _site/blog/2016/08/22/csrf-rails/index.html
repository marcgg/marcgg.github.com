<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <title> Understanding Rails' Forgery Protection Strategies </title> <meta name="description" content="Rails protects you against CSRF attacks, but it gives you a lot of customisation on how you want to react to them. It can be a great thing as you can have your own strategies, but it can also lead to security issues."> <meta name="author" content="Marc G Gauthier"> <meta content='user-scalable=no, width=device-width, initial-scale=1.0' name='viewport'> <meta name="google-site-verification" content="x2EpQdOMz-k9fP8hak9I3COaXhnQ4jNLp2GU4GYQ8jM" /> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="@marcgg"> <meta name="twitter:creator" content="@marcgg"> <meta name="twitter:title" content="Understanding Rails' Forgery Protection Strategies"> <meta name="twitter:description" content="Rails protects you against CSRF attacks, but it gives you a lot of customisation on how you want to react to them. It can be a great thing as you can have your own strategies, but it can also lead to security issues."> <meta name="twitter:image" content="https://marcgg.com/assets/previews/2016-08-22-csrf-rails.jpg" /> <meta name="image" property="og:image" content="https://marcgg.com/assets/previews/2016-08-22-csrf-rails.jpg" /> <link href='//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic|Open+Sans:300italic,700italic,400,700,300' rel='stylesheet' type='text/css'> <link href="/atom.xml" rel="alternate" type="application/atom+xml" title="Marcgg#Blog"> <link rel="shortcut icon" href="/assets/favicon.png"> <style type="text/css"> /* http://meyerweb.com/eric/tools/css/reset/ v2.0 | 20110126 License: none (public domain) */ html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video { margin: 0; padding: 0; border: 0; font-size: 100%; font: inherit; vertical-align: baseline; } /* HTML5 display-role reset for older browsers */ article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section { display: block; } body { line-height: 1; } ol, ul { list-style: none; } blockquote, q { quotes: none; } blockquote:before, blockquote:after, q:before, q:after { content: ''; content: none; } table { border-collapse: collapse; border-spacing: 0; } .clearfix:after { content: "."; display: block; clear: both; visibility: hidden; line-height: 0; height: 0; } .clearfix { display: inline-block; } html[xmlns] .clearfix { display: block; } * html .clearfix { height: 1%; } @font-face { font-family: 'anonymousregular'; src: url('/assets/fonts/Anonymous-webfont.eot'); src: url('/assets/fonts/Anonymous-webfont.eot?#iefix') format('embedded-opentype'), url('/assets/fonts/Anonymous-webfont.woff') format('woff'), url('/assets/fonts/Anonymous-webfont.ttf') format('truetype'), url('/assets/fonts/Anonymous-webfont.svg#anonymousregular') format('svg'); font-weight: normal; font-style: normal; } body{ font-size: 15px; font-family: 'Droid Serif', serif; color: #353535; line-height: 25px; } #gradient{ height: 5px; background: rgba(237,82,82,0.64); background: -moz-linear-gradient(left, rgba(237,82,82,0.64) 0%, rgba(250,21,0,0.65) 20%, rgba(237,82,82,0.66) 52%, rgba(255,21,0,0.66) 80%, rgba(237,82,82,0.67) 100%); background: -webkit-gradient(left top, right top, color-stop(0%, rgba(237,82,82,0.64)), color-stop(20%, rgba(250,21,0,0.65)), color-stop(52%, rgba(237,82,82,0.66)), color-stop(80%, rgba(255,21,0,0.66)), color-stop(100%, rgba(237,82,82,0.67))); background: -webkit-linear-gradient(left, rgba(237,82,82,0.64) 0%, rgba(250,21,0,0.65) 20%, rgba(237,82,82,0.66) 52%, rgba(255,21,0,0.66) 80%, rgba(237,82,82,0.67) 100%); background: -o-linear-gradient(left, rgba(237,82,82,0.64) 0%, rgba(250,21,0,0.65) 20%, rgba(237,82,82,0.66) 52%, rgba(255,21,0,0.66) 80%, rgba(237,82,82,0.67) 100%); background: -ms-linear-gradient(left, rgba(237,82,82,0.64) 0%, rgba(250,21,0,0.65) 20%, rgba(237,82,82,0.66) 52%, rgba(255,21,0,0.66) 80%, rgba(237,82,82,0.67) 100%); background: linear-gradient(to right, rgba(237,82,82,0.64) 0%, rgba(250,21,0,0.65) 20%, rgba(237,82,82,0.66) 52%, rgba(255,21,0,0.66) 80%, rgba(237,82,82,0.67) 100%); filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ed5252', endColorstr='#ed5252', GradientType=1 ); } /* STRUCTURE */ #container{ background-color: #fafafa; } #content{ width: 760px; margin: auto; margin-top: 40px; padding-bottom: 60px; padding-top: 40px; } /* FOOTER */ footer{ padding: 40px 0px; text-align: center; border-top: 1px solid #e6e6e6; font-size: 0.8em; color: #9a9a9a; background-color: #fafafa; } footer a{ color: #9a9a9a; } /* HEADER */ header{ width: 760px; margin: auto; height: 50px; border-bottom: 1px solid #f1f1f1; position: relative; } #more-nav{ font-size: 0.75em; display: inline-block; position: absolute; top: 0px; font-family: "anonymousregular"; padding-top: 5px; right: 0px; } #more-nav a{ padding: 0px 2px; text-decoration: none; color: #353535; } #more-nav a:hover{ transition: 0s; background-image: linear-gradient(to bottom, #fff 30%, rgba(200, 200, 200, 0.4) 50%); background-repeat: repeat-x; background-size: 2px 2px; background-position: 0px 100%; } #more-nav .selected{ color: #ed5252; font-weight: bold; } #logo{ font-size: 1.2em; font-family: "anonymousregular"; margin-top: 20px; } #logo *{ text-decoration: none; } #logo1{ color: #999; } #logo2{ font-size: 0.8em; color: #ed5252; } #logo3{ color: #353535; } #logo a:hover{ color: #ed5252; transition-duration: 1s; } /* TEXT STRUCTURE */ h1, h2, h3, h4, h5{ font-family: 'Open Sans', sans-serif; color: #1c1c1c; } a:hover{ color: #ed5252; transition-duration:0.2s; } p a, ul a, .review a{ color: #763232; text-decoration: none; background-image: linear-gradient(to bottom, #fff 30%, rgba(200, 200, 200, 0.4) 50%); background-repeat: repeat-x; background-size: 2px 2px; background-position: 0px 100%; } .homepage a{ color: #353535; } p{ text-align: justify; margin-bottom: 20px; } .excerpt p{ margin-bottom: 0px; } .footnote, .sidenote{ margin: 40px 0px; color: #858585; text-align: right; font-size: 0.9em; font-style: italic; } .image_notes{ text-align: center; color: #858585; font-size: 0.9em; margin: -5px 0px 15px 0px; } h1{ font-size: 2.45em; text-align: center; margin: 70px 0px 20px 0px; line-height : 1.5em; } h1 em{ color: #888; font-weight: normal; font-size: 0.8em; } h2{ font-size: 1.75em; margin: 50px 0px 50px 0px; line-height: 1.75em; } h2::before{ content: "#"; color: #ed5252; font-family: "anonymousregular"; display: inline-block; float: left; padding: 3px 10px 0px 0px; font-size: 0.7em; } h3{ font-size: 1.35em; margin-bottom: 20px; } h4{ font-size: 1.2em; margin-bottom: 20px; font-style: italic; } h5{ font-size: 1.3em; margin-bottom: 20px; } h5 *{ color: #353535; } em{ font-style: italic; } strong{ font-weight: bold; } blockquote{ border-left: 3px solid #ddd; color: #888; margin: 0px 0px 20px 40px; font-style: italic; } blockquote p{ margin: 5px 20px !important; } ul{ padding-left: 40px; line-height: 25px; list-style: square; margin-bottom: 20px; } li{ display: list-item; } ol{ padding-left: 40px; line-height: 25px; margin-bottom: 20px; list-style-type: decimal; } /* TAGS */ .home-tag { font-size: 10px; display: inline-block; border: 1px solid #dedede; padding: 2px 2px 1px 2px; border-radius: 2px; line-height: 10px; margin-left: 1px; } .tag-date{ color: #aaa; } .tag-management { border-color: #929aff; color: #929aff; } .tag-programming { border-color: #ff9292; color: #ff9292; } .tag-coaching { border-color: #4ec698; color: #4ec698; } .tag-projectmanagement { border-color: #929aff; color: #929aff; } /* BLOG INDEX */ #all-posts{ margin: 0px auto 10px auto; width: 760px; } .single-post{ border-top: 1px solid #f1f1f1; padding: 40px 0px; float: clear; } .single-post:first-child{ border-top: none !important; } .single-post .date{ color: #cdcdcd; margin-top: 10px; float: right; } .single-post .author{ color: #cdcdcd; float: right; font-size: 0.7em; } .single-post .title{ font-family: 'Open Sans', sans-serif; font-size: 1.6em; margin-bottom: 20px; line-height: 1.6em; position: relative; } .single-post .title a{ color: #353535; text-decoration: none; } .single-post .title a::before{ content: "→"; opacity: 0; font-family: "anonymousregular"; font-size: 0.7em; position: absolute; left: -30px; transition: all .4s ease-in-out; } .single-post .title a:hover::before{ opacity: 1; transition: all .4s ease-in-out; color: #ed5252; } .single-post .title em{ display: none; } .data_table{ border: 1px solid #efefef; font-family: "anonymousregular"; font-size: 12px; margin: auto auto 20px auto; } .data_table tr{ border: 1px solid #efefef; } .data_table th{ background-color: #efefef; } .data_table th, .data_table td{ padding: 2px 5px; } .post table { margin: 0px auto 20px auto; border: 1px solid #dedede; } .post td { padding: 5px 10px; } /* BOOKS */ .book-cover-entry{ width: 120px; margin-right: 20px; float: left; font-size: 12px; text-decoration: none !important; } .buy-book{ text-decoration: underline; } .book-cover-entry img{ width: 120px; } .book-cover-entry { background-image: none; } .book-rating .icon { display: inline-block; padding-right: 5px; } .book-rating .top .icon{ color: #1CED00; } .book-rating .good .icon{ color: #82ED00; } .book-rating .medium .icon{ color: #EDD100; } .book-rating .low .icon{ color: #EDAE00; } .book-rating .poor .icon{ color: #ED3B00; } #buy-title{ padding: 0px 0px 25px 0px; } #buy-title span{ font-size: 0.8em !important; color: #cdcdcd; } #buy-popin{ padding: 30px 15px; } .store{ display: block; padding: 15px 5px; text-decoration: none; } .store:hover{ color: #ed5252; } #upcoming-books{ padding-top: 20px; } #upcoming-books img{ height: 90px; margin-right: 10px; border: 1px solid #fff; } #upcoming-books a{ text-decoration: none; } #upcoming-books img:hover{ border: 1px solid #ed5252; } /* BLOG SHOW */ .post{ } p code, li code{ background-color: #efefef; font-family: "Lucida Console", "Courier New", Courier, monospace; padding: 1px 2px; font-size: 13px; } .post img{ border: 1px solid #e6e6e6; padding: 5px; margin: 0px 0px 20px 20px; } .published span{ border-top: 1px solid #e6e6e6; display: inline-block; color: #858585; padding-top: 5px; font-family: 'Open Sans', sans-serif; font-size: 0.9em; padding: 5px 20px 0px 20px; } .published{ text-align: center; margin-bottom: 65px; } #more{ border-top: 1px solid #e6e6e6; margin-top: 40px; padding: 40px 0px; } #more-articles{ margin-bottom: 40px; } .image-wrapper em{ display: block; font-size: 0.8em; margin: -20px 0px 20px 0px; color: #aaa; } .image-wrapper em a{ color: #aaa; } .twitter-tweet{ margin: auto; max-width: 420px !important; } #book-review{ border: 1px dashed #dedede; padding: 20px; margin-bottom: 20px; opacity: 0.7; } #book-review a{ color: #763232; } /* Music */ .js_play_sound, .js_stop_sound{ display: inline-block; padding: 4px 10px 2px 10px; border: 1px solid #efefef; background-color: #efefef; margin-right: 10px; text-decoration: none; border-radius: 3px; font-family: 'anonymousregular'; font-size: 12px; } .js_play_sound:hover, .js_stop_sound:hover{ background-color: #dedede; } /* Comments */ #comments{ padding-top: 20px; } #show-disqus-arrow{ color: #ed5252; } /* CLEARFIX */ .cf:before, .cf:after { content: " "; /* 1 */ display: table; /* 2 */ } .cf:after { clear: both; } /************************ MOBILE LAYOUT *********************/ @media all and (max-width: 800px) { .home-tag { display: none; } .author{ float: none !important; display: inline; } header{ width: 92%; padding: 4%; height: 75px; position: relative; text-align: center; background-color: #fafafa; } #more-nav{ left: 0px; top: 50px; } #logo{ margin-top: 10px; } #content, #all-posts{ width: 92%; padding: 4%; } .image-wrapper{ width: 100%; } .image-wrapper img, .post div img, .post p img{ max-width: 100% !important; padding: 15px 0px !important; margin: 20px 0px 20px 0px !important; border-right: 0px; border-left: 0px; } .single-post .title{ font-size: 1.4em; } .date{ display: none; } h1{ font-size: 1.7em; width: 94%; padding: 3%; } h2{ font-size: 1.50em; margin: 30px 0px 30px 0px; line-height: 1.75em; } h3{ font-size: 1.30em; } blockquote{ margin: 0px 0px 20px 0px !important; } pre{ margin-left: 0px !important; margin-right: 0px !important; width: 90%; overflow-x: scroll; } code{ width: 100%; font-size: 13px !important; } footer div{ display: inline; } /* Hire me responsive */ #hire ul{ padding-left: 15px; } #talking-img{ width: 100%; } #talking-img img{ width: 100% !important; } #reviews{ border-top: 1px dashed #e6e6e6; padding: 15px 0px 15px 0px; } #references_logo{ padding: 0px 0px 15px 0px; } .review{ width: 100%; margin: 0px 0px 15px 0px; padding: 0px; border-bottom: 1px dashed #e6e6e6; } #references_logo img, #references_logo .minor{ width: 22%; float: left; margin: 15px 2% 15px 0px; } .data_table th, .data_table td{ font-size: 8px; padding: 0px; border: 1px solid #efefef; } } /* CONVERSATION */ #post-conversation blockquote{ color: rgb(84, 84, 84); font-style: normal; margin: 20px 40px; } #post-conversation blockquote p{ margin: 10px 20px !important; } #post-conversation blockquote .dpm{ color: #3B9E2E !important; font-family: 'Open Sans', sans-serif; font-size: 13px; } #post-conversation blockquote .ddev{ color: #AD34CF !important; font-family: 'Open Sans', sans-serif; font-size: 13px; } #post-conversation blockquote .dcto{ color: #9E2E2E !important; font-family: 'Open Sans', sans-serif; font-size: 13px; } /* STATUS */ .status { background-color: #fff; padding: 40px; border: 1px solid #dba9a9; border-radius: 5px; margin: 40px 0px; } .status_text_content { font-size: 22px; line-height: 32px; } .status_text_content p { text-align: start !important; } .status_date { } .status_date a { color: #858585; text-decoration: none; } .status_images { margin: 20px auto; text-align: center; } .status_images img { max-width: 85%; max-height: 500px; </style> </head> <body> <div id="gradient"></div> <header> <div id="logo"> <a id='logo1' href="/">marcgg</a> <span id='logo2'>#</span> <a id='logo3' href="/blog/"> blog </a> </div> <div id="more-nav"> &rarr; <a href="/blog/" class="selected">blog</a> &rarr; <a href="/status/" class="">status</a> &rarr; <a href="/books/" class="">books</a> &rarr; <a href="/hire/" class="">hire me</a> </div> </header> <h1> <span> Understanding Rails' Forgery Protection Strategies </span> </h1> <div class="published"> <span>22 August 2016</span> </div> <div id="container"> <div id="content"> <div class="post" id="post-"> <p>Cross-site request forgery or <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a> is a well known attack that has been <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet">vastly documented</a>.</p> <p>To deal with this, Rails has the <code class="language-plaintext highlighter-rouge">RequestForgeryProtection</code> module that gives access to <code class="language-plaintext highlighter-rouge">protect_from_forgery</code>. It’s now set by default when you create a new Rails project and takes the form of a single line of code in the application controller:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with: :exception</span>
<span class="k">end</span></code></pre></figure> <p>This <code class="language-plaintext highlighter-rouge">with</code> parameter is actually the <code class="language-plaintext highlighter-rouge">forgery_protection_strategy</code> parameter, it tells Rails how to behave when a CSRF attack is identified.</p> <h2 id="the-different-forgery-protection-strategies">The Different Forgery Protection Strategies</h2> <p>There are <a href="https://github.com/rails/rails/blob/v5.0.0/actionpack/lib/action_controller/metal/request_forgery_protection.rb#L140-L198">3 strategies</a> currently built into the <code class="language-plaintext highlighter-rouge">RequestForgeryProtection ::ProtectionMethods</code> module of <code class="language-plaintext highlighter-rouge">ActionController</code>: <code class="language-plaintext highlighter-rouge">exception</code>, <code class="language-plaintext highlighter-rouge">null_session</code> and <code class="language-plaintext highlighter-rouge">reset_session</code>.</p> <p>The <code class="language-plaintext highlighter-rouge">null_session</code> strategy is the default one. The gotcha here is that by default Rails 5 generates the <code class="language-plaintext highlighter-rouge">ApplicationController</code> file with the <code class="language-plaintext highlighter-rouge">exception</code> strategy, but the default strategy <a href="https://github.com/rails/rails/blob/v5.0.0/actionpack/lib/action_controller/metal/request_forgery_protection.rb#L125">inside ActionPack</a> is actually the <code class="language-plaintext highlighter-rouge">null_session</code> one, which can be confusing.</p> <h3 id="exception">Exception</h3> <p>This is the one Rails 5 sets up by default. It will raise an exception if a CSRF attack occurs:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">protect_from_forgery</span> <span class="ss">with: :exception</span></code></pre></figure> <p>This strategy ensures that the execution stops right after the <code class="language-plaintext highlighter-rouge">verify_authenticity_token</code> check if the request is fraudulent.</p> <h3 id="null-session">Null Session</h3> <p>This strategy will not cause the app to crash but will instead <a href="https://github.com/rails/rails/blob/v5.0.0/actionpack/lib/action_controller/metal/request_forgery_protection.rb#L147-L153">nullify the session for the duration of the request</a>.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">protect_from_forgery</span>
<span class="c1"># or</span>
<span class="n">protect_from_forgery</span> <span class="ss">with: :null_session</span></code></pre></figure> <p>Note that while this is now the default, Rails 3 didn’t generate the <code class="language-plaintext highlighter-rouge">ApplicationController</code> file with the <code class="language-plaintext highlighter-rouge">with: :exception</code> parameter, so you didn’t touch a thing and have an old app that you kept on updating, you might have the <code class="language-plaintext highlighter-rouge">null_session</code> strategy set up and not even know it.</p> <h3 id="reset-session">Reset Session</h3> <p>The third strategy, <code class="language-plaintext highlighter-rouge">reset_session</code>, simply calls the <code class="language-plaintext highlighter-rouge">reset_session</code> of <code class="language-plaintext highlighter-rouge">@controller</code> as you can see <a href="https://github.com/rails/rails/blob/v5.0.0/actionpack/lib/action_controller/metal/request_forgery_protection.rb#L179-L187">here</a>.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">protect_from_forgery</span> <span class="ss">with: :reset_session</span></code></pre></figure> <h3 id="important-note-on-security">Important Note On Security</h3> <p>It is very important to keep in mind that <strong>fraudulent requests will go through</strong> with the <code class="language-plaintext highlighter-rouge">null_session</code> and <code class="language-plaintext highlighter-rouge">reset_session</code> strategies. The only action taken by these strategies is to make sure the session is empty during the request.</p> <p>As an illustration here are the logs for a fraudulent request:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Started POST "/posts"
Processing by PostsController#create as */*
Can't verify CSRF token authenticity.
Completed 200 OK in 2ms (Views: 1.0ms | ActiveRecord: 0.0ms)
</code></pre></div></div> <p>I think that it is quite counter intuitive and might cause serious security concerns depending on your implementation. Brakeman even considers using other strategies <a href="https://github.com/presidentbeef/brakeman/pull/648">to be an issue</a>.</p> <p>If you want to learn more about this, Jason Yeo explains it in depth in his great article, “<a href="https://blog.srcclr.com/when-rails-protect_from_forgery-fails/">When Rails’ protect from forgery Fails</a>”. If you’re unsure of your implementation, the safe approach is to use the <code class="language-plaintext highlighter-rouge">exception</code> strategy.</p> <h2 id="building-a-custom-strategy">Building A Custom Strategy</h2> <p>In some cases it can be interesting to build your own strategy. Let’s say you don’t want to return 500s when a CSRF attack occurs, but you still want to be warned or at least have better logs.</p> <h3 id="how-it-works">How It Works</h3> <p>First, let’s take a look at how all this works:</p> <div class="image-wrapper" style="text-align: center"><img src="/assets/blog/csrf_rails.jpg" alt="Google analytics drop" style="padding: 20px; width: 600px;" /></div> <p>The requests goes through <code class="language-plaintext highlighter-rouge">verify_authenticity_token</code>. If there is an issue, it then logs a warning and then calls the <code class="language-plaintext highlighter-rouge">handle_unverified_request</code> method of the <code class="language-plaintext highlighter-rouge">forgery_protection_strategy</code>.</p> <h3 id="getting-an-exception">Getting An Exception</h3> <p>First, let’s get a <code class="language-plaintext highlighter-rouge">InvalidAuthenticityToken</code> exception. If you want to do it properly, you probably want to do this writing tests, but to demonstrate this I’ll be using <a href="https://curl.haxx.se/">curl</a>.</p> <p>Start your server and call a POST action that has <code class="language-plaintext highlighter-rouge">protect_from_forgery</code> activated using curl. This way you’re sure that you don’t have the proper <a href="http://guides.rubyonrails.org/security.html#cross-site-request-forgery-csrf">authenticity token</a>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -X POST -I http://localhost:3000/secure_post_action
</code></pre></div></div> <p>You should see this in your logs:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Can't verify CSRF token authenticity.
Completed 422 Unprocessable Entity in 1ms (ActiveRecord: 0.0ms)
ActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken)
</code></pre></div></div> <h3 id="adding-a-custom-forgery-protection-strategy">Adding A Custom Forgery Protection Strategy</h3> <p>Now that we know how to quickly test, let’s add our new strategy.</p> <p>Any forgery propection strategy needs to be initalized with a controller and respond to <code class="language-plaintext highlighter-rouge">handle_unverified_request</code>. So the bare minimum here is:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">MyStrategy</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">handle_unverified_request</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>Then you can use it by changing your controller code:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
 <span class="n">protect_from_forgery</span> <span class="ss">with: </span><span class="no">MyStrategy</span>
<span class="k">end</span></code></pre></figure> <p>Now you can get your strategy to do whatever you’d like and check the result by running the curl command. To give you ideas, here’s what I implemented on a project to get a bit more logs while still falling back on the <code class="language-plaintext highlighter-rouge">null_session</code> strategy:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">LoggingForgeryStrategy</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
    <span class="vi">@controller</span> <span class="o">=</span> <span class="n">controller</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">handle_unverified_request</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">warn</span> <span class="p">[</span>
      <span class="s2">"handle_unverified_request"</span><span class="p">,</span>
      <span class="s2">"</span><span class="si">#{</span><span class="vi">@controller</span><span class="p">.</span><span class="nf">controller_name</span><span class="si">}</span><span class="s2">#</span><span class="si">#{</span><span class="vi">@controller</span><span class="p">.</span><span class="nf">action_name</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
      <span class="s2">"params=</span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">params</span><span class="si">}</span><span class="s2">"</span>
    <span class="p">].</span><span class="nf">join</span><span class="p">(</span><span class="s2">" - "</span><span class="p">)</span>

    <span class="n">null_session</span><span class="p">.</span><span class="nf">handle_unverified_request</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">request</span>
    <span class="vi">@request</span> <span class="o">||=</span> <span class="vi">@controller</span><span class="p">.</span><span class="nf">request</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">null_session</span>
   <span class="no">ActionController</span><span class="o">::</span><span class="no">RequestForgeryProtection</span><span class="o">::</span><span class="no">ProtectionMethods</span><span class="o">::</span><span class="no">NullSession</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@controller</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <div id="more"> <div id="more-articles"> <p>Since you scrolled this far, you might be interested in some other things I wrote:</p> <ul> <li><a href="/blog/2020/04/11/add-text-image-rmagick-imagemagick/">Add Text Over an Image with Ruby</a></li> <li><a href="/blog/2020/04/08/rails-update-bang/">Misuse of update/update! in Ruby on Rails</a></li> <li><a href="/blog/2018/10/22/regression-testing-for-data-ruby/">Regression Testing For Data</a></li> <li><a href="/blog/2018/05/15/expressing-intent-comments-ruby/">Expressing Intent Without Comments In Ruby</a></li> <li><a href="/blog/2017/01/23/ruby-to-s-to-str/">The Difference Between to&#95;s & to&#95;str In Ruby</a></li> <li><a href="/blog/2016/05/09/rails-app-engine/">First Impressions: Rails 5 on Google App Engine</a></li> <li><a href="/blog/2016/02/15/rspec-on-multiple-rails-projects/">Automatically Run RSpec on Multiple Projects</a></li> <li><a href="/books/">Startup & Tech Book Reviews</a> </ul> </div> <div class="container comments" id="comments"> Loading comments... </div> <div id="comment_form_wrapper" class="container"> <form id="comment_form"> <textarea name="content" required id="comment_content" placeholder="Leave a comment"/></textarea /> <div id="comment_additional" class="row" style="display: none;"> <div class="col-sm-4"> <input type="text" id="comment_name" required placeholder="Your name*" /> </div> <div class="col-sm-4"> <input type="text" id="comment_website" placeholder="Your site" /> </div> <div class="col-sm-4"> <input type="email" id="comment_email" required placeholder="Your email* (won't be displayed)" /> </div> </div> <br /> <input type="submit" id="submit_comment" value="Send"/> <div id="submit_loading" style="display: none;">...</div> </form> </div> </div> </div> </div> </div> <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> <script src="/assets/js/comments.js"></script> <link rel="preload" href="/assets/css/code.css" as="style" onload="this.rel='stylesheet'"> <link href="/assets/css/comments.css?body=1" rel="stylesheet" type="text/css" media="all"> <script> /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */ !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); /*! loadCSS rel=preload polyfill. [c]2017 Filament Group, Inc. MIT License */ !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); </script> <footer> <div>Website powered by <a href="https://github.com/jekyll/jekyll">Jekyll</a>, hosted on <a href="https://github.com/marcgg/marcgg.github.com">Github</a>. <br> All of the <a href="/blog">blog's articles</a>, <a href="/status">status</a> and site content in general is under Copyright &copy;. <br> If you want to use this content, please contact me.</div> </footer> <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-31071519-1']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </body> </html>

